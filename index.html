<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Rotas</title>
    <!-- Bootstrap CSS -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-6mBO4Q2QNjI6ta4JHIHQ7V8CB6xQhzQPpSg5Ngfxk03vJw/sJfbLw8cHYHfqgw6l" 
        crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1d3557, #457b9d);
            color: #fff;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            background: #f1faee;
            color: #1d3557;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            margin: 2rem auto;
        }

        .btn-custom {
            background-color: #d3c618;
            border-radius: 5px;
        }

        .btn-custom:hover {
            background-color: #1d3557;
        }

        .input-group input {
            height: 40px;
            border-color: #457b9d;
        }

        .input-group input:focus {
            border-color: #1d3557;
            box-shadow: 0 0 5px rgba(29, 53, 87, 0.5);
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .historico {
            margin-top: 2rem;
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
        }

        .historico h4 {
            margin-bottom: 1rem;
        }

        .historico ul {
            list-style-type: none;
            padding-left: 0;
        }

        .historico li {
            margin-bottom: 0.5rem;
            background-color: #f1f1f1;
            padding: 0.5rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* margin: 10px; */
        }
        
        .colunas {
            flex-direction: row;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="flex">
            <div class="colunas">
                <h1 class="mb-4 text-center">Gerador de Rotas</h1>
            </div>
            <div class="colunas">
                <button id="vai" class="btn btn-custom text-white btn-lg w-100 mb-3">Abrir Rota</button>
            </div>
        </div>
        <div>
            <span>Endereços e Produtos:</span>
            <button id="btnMais" class="btn btn-success btn-sm ms-2">Adicionar</button>
        </div>
        <div id="enderecos" class="mt-4"></div>

        <div class="historico">
            <h4>Histórico de Endereços e Produtos</h4>
            <ul id="historico-lista"></ul>
            <button id="limparHistorico" class="btn btn-danger w-100 mt-3">Limpar Histórico</button>
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- Bootstrap Bundle with Popper -->
    <script 
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-HoA6KwCOZwcILUnF98UC/IdIwjqMxboNL2pSnDbpRh29V4x1JY3MEbcHzyhCXKkc" 
        crossorigin="anonymous"></script>

    <script>
        // Inicializa o Dexie.js para inputs
        const dbInputs = new Dexie("RotaInputsDB");
        dbInputs.version(1).stores({
            enderecos: "++id, endereco, produto"
        });

        // Inicializa o Dexie.js para o histórico
        const dbHistorico = new Dexie("RotaHistoricoDB");
        dbHistorico.version(1).stores({
            historico: "++id, endereco, produto"
        });

        // Função para carregar os dados dos inputs
        async function carregarEnderecos() {
            const registros = await dbInputs.enderecos.toArray();
            registros.forEach(({ id, endereco, produto }) => adicionarLinha(endereco, produto, id));
            carregarHistorico();
        }

        // Função para adicionar uma linha ao DOM
        function adicionarLinha(endereco = "", produto = "", id = null) {
            const inputEnd = document.querySelector("#enderecos");

            const inputGroup = document.createElement("div");
            inputGroup.className = "input-group";
            inputGroup.dataset.id = id;

            const inputId = document.createElement("input");
            inputId.type = "text";
            inputId.hidden = true;
            inputId.placeholder = "id";
            inputId.value = id;
            inputGroup.appendChild(inputId);

            const inputEndereco = document.createElement("input");
            inputEndereco.type = "text";
            inputEndereco.className = "form-control";
            // inputEndereco.classList = "form-control flex";
            inputEndereco.placeholder = "Endereço";
            inputEndereco.value = endereco;

            const inputProduto = document.createElement("input");
            inputProduto.type = "text";
            inputProduto.className = "form-control ms-2";
            inputProduto.placeholder = "Produto";
            inputProduto.value = produto;

            const addButton = document.createElement("button");
            addButton.className = "btn btn-primary ms-2";
            addButton.innerHTML = "Adicionar ao Histórico";
            addButton.addEventListener("click", async () => {
                // Verifica se o endereço e produto já estão no histórico
                const historicoExistente = await dbHistorico.historico.where("endereco").equals(inputEndereco.value).and(
                    (item) => item.produto === inputProduto.value
                ).toArray();

                if (historicoExistente.length > 0) {
                    alert("Este endereço e produto já foram adicionados ao histórico.");
                } else {
                    const registroId = parseInt(inputGroup.dataset.id, 10);
                    await dbInputs.enderecos.update(registroId, { endereco: inputEndereco.value, produto: inputProduto.value });
                    salvarNoHistorico(inputEndereco.value, inputProduto.value);
                }
            });

            const removeButton = document.createElement("button");
            removeButton.className = "btn btn-danger ms-2";
            removeButton.innerHTML = "Remover";
            removeButton.addEventListener("click", async () => {
                const registroId = parseInt(inputGroup.dataset.id, 10);
                await dbInputs.enderecos.delete(registroId); // Remove do banco de dados dos inputs
                inputGroup.remove(); // Remove do DOM
                carregarHistorico(); // Atualiza o histórico
            });

            inputGroup.appendChild(inputEndereco);
            inputGroup.appendChild(inputProduto);
            inputGroup.appendChild(addButton);
            inputGroup.appendChild(removeButton);

            inputEnd.appendChild(inputGroup);
        }

        // Adiciona nova linha e salva no banco
        const botaoMais = document.querySelector("#btnMais");
        botaoMais.addEventListener("click", async () => {
            const id = await dbInputs.enderecos.add({ endereco: "", produto: "" });
            adicionarLinha("", "", id);
        });

        // Gera o link do Google Maps com os endereços
        const vai = document.querySelector("#vai");
        vai.addEventListener("click", async () => {
            let aux = "";
            document.querySelectorAll("#enderecos .input-group input:nth-child(2)").forEach(input => {
                if (input.value) {
                    aux += input.value + "/";
                }
            });

            const link = "https://www.google.com.br/maps/dir/";
            window.location.href = link + aux;
        });

        // Função para carregar o histórico de endereços e produtos
        async function carregarHistorico() {
            const listaHistorico = document.querySelector("#historico-lista");
            listaHistorico.innerHTML = "";

            const registros = await dbHistorico.historico.toArray();
            registros.forEach(({ id, endereco, produto }) => {
                const li = document.createElement("li");
                li.textContent = `${endereco} - Produto: ${produto}`;

                const removeButton = document.createElement("button");
                removeButton.className = "btn btn-danger btn-sm";
                removeButton.textContent = "Remover";
                removeButton.addEventListener("click", async () => {
                    await dbHistorico.historico.delete(id);
                    carregarHistorico(); // Atualiza o histórico
                });

                li.appendChild(removeButton);
                listaHistorico.appendChild(li);
            });
        }

        // Limpa o conteúdo visual do histórico, mas mantém os dados
        const limparHistorico = document.querySelector("#limparHistorico");
        limparHistorico.addEventListener("click", async () => {
            const listaHistorico = document.querySelector("#historico-lista");
            listaHistorico.innerHTML = ""; // Limpa a lista visual
            await dbHistorico.historico.clear(); // Limpa os dados do histórico no banco Dexie
        });

        // Função para salvar no histórico
        async function salvarNoHistorico(endereco, produto) {
            await dbHistorico.historico.add({ endereco, produto });
            carregarHistorico(); // Atualiza o histórico visual
        }

        // Chama para carregar os dados quando a página é carregada
        carregarEnderecos();
    </script>
</body>
</html>
